<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HORBTEC ADMIN UNITS - UGANDA</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #1a3a8f 0%, #0d6efd 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        
        .header h1::before {
            content: "üó∫Ô∏è";
            margin-right: 15px;
            font-size: 32px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
            max-width: 800px;
        }
        
        .content-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .control-panel {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .map-container {
            flex: 2;
            min-width: 500px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            height: 600px;
        }
        
        #map {
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }
        
        .hierarchy-selector {
            margin-bottom: 25px;
        }
        
        .hierarchy-selector h2 {
            font-size: 20px;
            color: #1a3a8f;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeef5;
            display: flex;
            align-items: center;
        }
        
        .hierarchy-selector h2::before {
            content: "üìã";
            margin-right: 10px;
        }
        
        .select-group {
            margin-bottom: 18px;
        }
        
        .select-group label {
            display: block;
            font-weight: 600;
            color: #444;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .select-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d0d7e2;
            border-radius: 8px;
            font-size: 15px;
            background-color: white;
            color: #333;
            transition: all 0.3s;
        }
        
        .select-group select:focus {
            outline: none;
            border-color: #0d6efd;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
        }
        
        .select-group select:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #0d6efd;
            color: white;
            flex: 1;
        }
        
        .btn-primary:hover {
            background-color: #0b5ed7;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            flex: 1;
        }
        
        .btn-secondary:hover {
            background-color: #5c636a;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: #198754;
            color: white;
            flex: 1;
        }
        
        .btn-success:hover {
            background-color: #157347;
            transform: translateY(-2px);
        }
        
        .data-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-top: 20px;
        }
        
        .data-panel h2 {
            font-size: 20px;
            color: #1a3a8f;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeef5;
            display: flex;
            align-items: center;
        }
        
        .data-panel h2::before {
            content: "üìä";
            margin-right: 10px;
        }
        
        #data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        #data-table th {
            background-color: #f8f9fa;
            padding: 14px 15px;
            text-align: left;
            font-weight: 700;
            color: #444;
            border-bottom: 2px solid #eaeef5;
        }
        
        #data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            color: #555;
        }
        
        #data-table tr:hover {
            background-color: #f8fafd;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #0d6efd;
            font-weight: 600;
        }
        
        .loading::after {
            content: " ‚è≥";
        }
        
        .info-message {
            background-color: #e7f1ff;
            border-left: 4px solid #0d6efd;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eaeef5;
            color: #6c757d;
            font-size: 14px;
        }
        
        @media (max-width: 1100px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .control-panel, .map-container {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>HORBTEC ADMIN UNITS - UGANDA</h1>
            <p>Explore Uganda's administrative hierarchy from Region down to Village level. Select administrative units and download boundary data for your projects.</p>
        </div>
        
        <div class="content-wrapper">
            <div class="control-panel">
                <div class="hierarchy-selector">
                    <h2>Administrative Hierarchy Selection</h2>
                    
                    <div class="select-group">
                        <label for="region-select">Region (4 total)</label>
                        <select id="region-select">
                            <option value="">Select a region</option>
                            <option value="Central">Central Region</option>
                            <option value="Eastern">Eastern Region</option>
                            <option value="Northern">Northern Region</option>
                            <option value="Western">Western Region</option>
                        </select>
                    </div>
                    
                    <div class="select-group">
                        <label for="district-select">District (146 total)</label>
                        <select id="district-select" disabled>
                            <option value="">First select a region</option>
                        </select>
                    </div>
                    
                    <div class="select-group">
                        <label for="county-select">County</label>
                        <select id="county-select" disabled>
                            <option value="">First select a district</option>
                        </select>
                    </div>
                    
                    <div class="select-group">
                        <label for="subcounty-select">Sub-county</label>
                        <select id="subcounty-select" disabled>
                            <option value="">First select a county</option>
                        </select>
                    </div>
                    
                    <div class="select-group">
                        <label for="parish-select">Parish</label>
                        <select id="parish-select" disabled>
                            <option value="">First select a sub-county</option>
                        </select>
                    </div>
                    
                    <div class="select-group">
                        <label for="village-select">Village</label>
                        <select id="village-select" disabled>
                            <option value="">First select a parish</option>
                        </select>
                    </div>
                    
                    <div class="info-message">
                        Uganda is divided into 4 regions, 146 districts, and further subdivided into counties, sub-counties, parishes, and villages[citation:1][citation:3].
                    </div>
                    
                    <div class="button-group">
                        <button id="fetch-boundary-btn" class="btn btn-primary">
                            <span>üó∫Ô∏è Fetch Boundary</span>
                        </button>
                        <button id="download-data-btn" class="btn btn-success">
                            <span>üì• Download Data</span>
                        </button>
                        <button id="reset-btn" class="btn btn-secondary">
                            <span>üîÑ Reset Selection</span>
                        </button>
                    </div>
                </div>
                
                <div class="loading" id="loading-indicator">
                    Loading data, please wait...
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
        
        <div class="data-panel">
            <h2>Administrative Unit Data</h2>
            <div id="data-info"></div>
            <table id="data-table">
                <thead>
                    <tr>
                        <th>Level</th>
                        <th>Name</th>
                        <th>Parent Unit</th>
                        <th>Data Source</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="data-table-body">
                    <tr>
                        <td colspan="5" style="text-align: center;">Select an administrative unit to view data</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            <p>¬© 2026 HORBTEC ADMIN UNITS - UGANDA | Data sourced from OpenStreetMap and OpenData Uganda API | Uganda has 4 regions and 146 districts[citation:1][citation:3]</p>
        </div>
    </div>

    <script>
        // Base configuration
        const baseURL = 'https://opendata.ssmusoke.dev/api/locations';
        let currentBoundaryLayer = null;
        let currentSelection = {
            region: null,
            district: null,
            county: null,
            subcounty: null,
            parish: null,
            village: null
        };
        
        // Initialize Leaflet map centered on Uganda
        const map = L.map('map').setView([1.3733, 32.2903], 7);
        
        // Add base tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);
        
        // Add Uganda outline for context
        fetch('https://overpass-api.de/api/interpreter?data=[out:json];relation["ISO3166-2"="UG"][admin_level=2];out geom;')
            .then(response => response.json())
            .then(data => {
                if (data.elements && data.elements.length > 0) {
                    const ugandaRelation = data.elements[0];
                    if (ugandaRelation.geometry) {
                        const ugandaCoords = ugandaRelation.geometry.map(point => [point.lat, point.lon]);
                        L.polygon(ugandaCoords, {
                            color: '#1a3a8f',
                            weight: 2,
                            opacity: 0.5,
                            fillOpacity: 0.1,
                            fillColor: '#1a3a8f'
                        }).addTo(map).bindPopup('<b>Uganda</b><br>Administrative Boundaries Module');
                    }
                }
            })
            .catch(error => console.error('Error loading Uganda outline:', error));
        
        // Region selection handler
        document.getElementById('region-select').addEventListener('change', function(e) {
            const region = e.target.value;
            currentSelection.region = region;
            
            if (region) {
                loadDistricts(region);
                updateDataTable();
            } else {
                resetLowerLevels('district');
            }
        });
        
        // District selection handler
        document.getElementById('district-select').addEventListener('change', function(e) {
            const district = e.target.value;
            currentSelection.district = district;
            
            if (district) {
                loadCounties(district);
                updateDataTable();
            } else {
                resetLowerLevels('county');
            }
        });
        
        // County selection handler
        document.getElementById('county-select').addEventListener('change', function(e) {
            const county = e.target.value;
            currentSelection.county = county;
            
            if (county) {
                loadSubCounties(county);
                updateDataTable();
            } else {
                resetLowerLevels('subcounty');
            }
        });
        
        // Sub-county selection handler
        document.getElementById('subcounty-select').addEventListener('change', function(e) {
            const subcounty = e.target.value;
            currentSelection.subcounty = subcounty;
            
            if (subcounty) {
                loadParishes(subcounty);
                updateDataTable();
            } else {
                resetLowerLevels('parish');
            }
        });
        
        // Parish selection handler
        document.getElementById('parish-select').addEventListener('change', function(e) {
            const parish = e.target.value;
            currentSelection.parish = parish;
            
            if (parish) {
                loadVillages(parish);
                updateDataTable();
            } else {
                resetLowerLevels('village');
            }
        });
        
        // Village selection handler
        document.getElementById('village-select').addEventListener('change', function(e) {
            currentSelection.village = e.target.value;
            updateDataTable();
        });
        
        // Load districts for selected region
        async function loadDistricts(region) {
            const districtSelect = document.getElementById('district-select');
            districtSelect.disabled = true;
            districtSelect.innerHTML = '<option value="">Loading districts...</option>';
            
            try {
                const response = await fetch(`${baseURL}/districts?filter[region]=${encodeURIComponent(region)}`);
                const data = await response.json();
                
                districtSelect.innerHTML = '<option value="">Select a district</option>';
                data.data.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.id;
                    option.textContent = district.name;
                    districtSelect.appendChild(option);
                });
                
                districtSelect.disabled = false;
                resetLowerLevels('district');
            } catch (error) {
                console.error('Error loading districts:', error);
                districtSelect.innerHTML = '<option value="">Error loading districts</option>';
            }
        }
        
        // Load counties for selected district
        async function loadCounties(districtId) {
            const countySelect = document.getElementById('county-select');
            countySelect.disabled = true;
            countySelect.innerHTML = '<option value="">Loading counties...</option>';
            
            try {
                const response = await fetch(`${baseURL}/counties?filter[district]=${districtId}`);
                const data = await response.json();
                
                countySelect.innerHTML = '<option value="">Select a county</option>';
                data.data.forEach(county => {
                    const option = document.createElement('option');
                    option.value = county.id;
                    option.textContent = county.name;
                    countySelect.appendChild(option);
                });
                
                countySelect.disabled = false;
                resetLowerLevels('county');
            } catch (error) {
                console.error('Error loading counties:', error);
                countySelect.innerHTML = '<option value="">Error loading counties</option>';
            }
        }
        
        // Load sub-counties for selected county
        async function loadSubCounties(countyId) {
            const subcountySelect = document.getElementById('subcounty-select');
            subcountySelect.disabled = true;
            subcountySelect.innerHTML = '<option value="">Loading sub-counties...</option>';
            
            try {
                const response = await fetch(`${baseURL}/sub-counties?filter[county]=${countyId}`);
                const data = await response.json();
                
                subcountySelect.innerHTML = '<option value="">Select a sub-county</option>';
                data.data.forEach(subcounty => {
                    const option = document.createElement('option');
                    option.value = subcounty.id;
                    option.textContent = subcounty.name;
                    subcountySelect.appendChild(option);
                });
                
                subcountySelect.disabled = false;
                resetLowerLevels('subcounty');
            } catch (error) {
                console.error('Error loading sub-counties:', error);
                subcountySelect.innerHTML = '<option value="">Error loading sub-counties</option>';
            }
        }
        
        // Load parishes for selected sub-county
        async function loadParishes(subcountyId) {
            const parishSelect = document.getElementById('parish-select');
            parishSelect.disabled = true;
            parishSelect.innerHTML = '<option value="">Loading parishes...</option>';
            
            try {
                const response = await fetch(`${baseURL}/parishes?filter[subcounty]=${subcountyId}`);
                const data = await response.json();
                
                parishSelect.innerHTML = '<option value="">Select a parish</option>';
                data.data.forEach(parish => {
                    const option = document.createElement('option');
                    option.value = parish.id;
                    option.textContent = parish.name;
                    parishSelect.appendChild(option);
                });
                
                parishSelect.disabled = false;
                resetLowerLevels('parish');
            } catch (error) {
                console.error('Error loading parishes:', error);
                parishSelect.innerHTML = '<option value="">Error loading parishes</option>';
            }
        }
        
        // Load villages for selected parish
        async function loadVillages(parishId) {
            const villageSelect = document.getElementById('village-select');
            villageSelect.disabled = true;
            villageSelect.innerHTML = '<option value="">Loading villages...</option>';
            
            try {
                const response = await fetch(`${baseURL}/villages?filter[parish]=${parishId}`);
                const data = await response.json();
                
                villageSelect.innerHTML = '<option value="">Select a village</option>';
                data.data.forEach(village => {
                    const option = document.createElement('option');
                    option.value = village.id;
                    option.textContent = village.name;
                    villageSelect.appendChild(option);
                });
                
                villageSelect.disabled = false;
            } catch (error) {
                console.error('Error loading villages:', error);
                villageSelect.innerHTML = '<option value="">Error loading villages</option>';
            }
        }
        
        // Reset lower-level selects
        function resetLowerLevels(level) {
            const levels = ['region', 'district', 'county', 'subcounty', 'parish', 'village'];
            const levelIndex = levels.indexOf(level);
            
            for (let i = levelIndex + 1; i < levels.length; i++) {
                const selectId = `${levels[i]}-select`;
                const select = document.getElementById(selectId);
                select.innerHTML = `<option value="">First select a ${levels[i-1]}</option>`;
                select.disabled = true;
                currentSelection[levels[i]] = null;
            }
        }
        
        // Update data table with current selection
        function updateDataTable() {
            const tableBody = document.getElementById('data-table-body');
            const dataInfo = document.getElementById('data-info');
            
            // Clear table
            tableBody.innerHTML = '';
            
            // Build data rows
            const selections = [
                { level: 'Region', value: currentSelection.region, parent: 'Country' },
                { level: 'District', value: getSelectedText('district-select'), parent: currentSelection.region },
                { level: 'County', value: getSelectedText('county-select'), parent: getSelectedText('district-select') },
                { level: 'Sub-county', value: getSelectedText('subcounty-select'), parent: getSelectedText('county-select') },
                { level: 'Parish', value: getSelectedText('parish-select'), parent: getSelectedText('subcounty-select') },
                { level: 'Village', value: getSelectedText('village-select'), parent: getSelectedText('parish-select') }
            ];
            
            // Filter out empty selections
            const validSelections = selections.filter(item => item.value && item.value !== 'Select a' && !item.value.includes('First select'));
            
            if (validSelections.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Select an administrative unit to view data</td></tr>';
                dataInfo.innerHTML = '';
                return;
            }
            
            // Update info text
            const highestSelection = validSelections[validSelections.length - 1];
            dataInfo.innerHTML = `<div class="info-message">Currently viewing data for: <strong>${highestSelection.value}</strong> (${highestSelection.level})</div>`;
            
            // Add rows to table
            validSelections.forEach(item => {
                const row = document.createElement('tr');
                
                const levelCell = document.createElement('td');
                levelCell.textContent = item.level;
                
                const nameCell = document.createElement('td');
                nameCell.textContent = item.value;
                
                const parentCell = document.createElement('td');
                parentCell.textContent = item.parent || 'Uganda';
                
                const sourceCell = document.createElement('td');
                sourceCell.textContent = item.level === 'Region' ? 'GeoPostcodes[citation:3]' : 'OpenData Uganda API[citation:5]';
                
                const actionCell = document.createElement('td');
                const viewBtn = document.createElement('button');
                viewBtn.textContent = 'View Details';
                viewBtn.className = 'btn btn-primary';
                viewBtn.style.padding = '6px 12px';
                viewBtn.style.fontSize = '13px';
                viewBtn.onclick = () => {
                    alert(`Details for ${item.value} (${item.level}):\nParent: ${item.parent || 'Uganda'}\nSource: ${sourceCell.textContent}`);
                };
                actionCell.appendChild(viewBtn);
                
                row.appendChild(levelCell);
                row.appendChild(nameCell);
                row.appendChild(parentCell);
                row.appendChild(sourceCell);
                row.appendChild(actionCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // Get selected text from a select element
        function getSelectedText(selectId) {
            const select = document.getElementById(selectId);
            if (select.selectedIndex >= 0) {
                return select.options[select.selectedIndex].text;
            }
            return '';
        }
        
        // Fetch boundary data from Overpass API[citation:4][citation:6][citation:8]
        document.getElementById('fetch-boundary-btn').addEventListener('click', async function() {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = 'block';
            
            // Determine which level to query based on selection
            let queryLevel = null;
            let queryName = null;
            
            if (currentSelection.district && getSelectedText('district-select') !== 'Select a district') {
                queryLevel = 4; // District level in OSM[citation:1][citation:7]
                queryName = getSelectedText('district-select');
            } else if (currentSelection.region) {
                // For regions, we'll use a different approach
                showRegionBoundary(currentSelection.region);
                loadingIndicator.style.display = 'none';
                return;
            } else {
                alert('Please select at least a region or district to fetch boundary data.');
                loadingIndicator.style.display = 'none';
                return;
            }
            
            try {
                // Clear previous boundary layer
                if (currentBoundaryLayer) {
                    map.removeLayer(currentBoundaryLayer);
                    currentBoundaryLayer = null;
                }
                
                // Build Overpass query[citation:6][citation:8]
                const overpassQuery = `
                    [out:json][timeout:90];
                    relation["boundary"="administrative"]
                      ["admin_level"="${queryLevel}"]
                      ["name"="${queryName}"]
                      ({{bbox}});
                    out geom;
                `;
                
                // Get current map bounds
                const bounds = map.getBounds();
                const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
                const finalQuery = overpassQuery.replace('{{bbox}}', bbox);
                
                // Encode query for URL
                const encodedQuery = encodeURIComponent(finalQuery);
                const url = `https://overpass-api.de/api/interpreter?data=${encodedQuery}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.elements && data.elements.length > 0) {
                    const element = data.elements[0];
                    
                    if (element.geometry) {
                        const coords = element.geometry.map(point => [point.lat, point.lon]);
                        currentBoundaryLayer = L.polygon(coords, {
                            color: '#198754',
                            weight: 3,
                            opacity: 0.8,
                            fillOpacity: 0.2,
                            fillColor: '#198754'
                        }).addTo(map);
                        
                        // Zoom to the boundary
                        map.fitBounds(currentBoundaryLayer.getBounds());
                        
                        // Add popup with info
                        currentBoundaryLayer.bindPopup(`
                            <b>${queryName}</b><br>
                            Administrative Level: ${queryLevel}<br>
                            Type: ${queryLevel === 4 ? 'District' : 'Administrative Unit'}<br>
                            Source: OpenStreetMap[citation:1]
                        `).openPopup();
                        
                        // Update data table
                        updateDataTable();
                    }
                } else {
                    alert('No boundary data found for the selected area. Trying alternative source...');
                    // Try alternative approach for region boundaries
                    if (queryLevel === 4) {
                        showDistrictAlternative(queryName);
                    }
                }
            } catch (error) {
                console.error('Error fetching boundary:', error);
                alert('Error fetching boundary data. The server might be busy. Please try again.');
            } finally {
                loadingIndicator.style.display = 'none';
            }
        });
        
        // Show region boundary (simplified approach)
        function showRegionBoundary(regionName) {
            // Simplified coordinates for Uganda regions
            const regionCoordinates = {
                'Central': [[-0.5, 31], [0.8, 33], [0.5, 32], [-0.2, 31.5]],
                'Eastern': [[0.5, 33], [3.5, 34.5], [2.5, 34], [1.0, 33.5]],
                'Northern': [[2.5, 31], [4.0, 35], [3.5, 34], [2.8, 32]],
                'Western': [[-1.0, 29.5], [0.5, 31], [0.0, 30.5], [-0.8, 30]]
            };
            
            // Clear previous boundary layer
            if (currentBoundaryLayer) {
                map.removeLayer(currentBoundaryLayer);
            }
            
            const coords = regionCoordinates[regionName] || regionCoordinates['Central'];
            currentBoundaryLayer = L.polygon(coords, {
                color: '#0d6efd',
                weight: 3,
                opacity: 0.8,
                fillOpacity: 0.15,
                fillColor: '#0d6efd'
            }).addTo(map);
            
            // Add popup
            currentBoundaryLayer.bindPopup(`
                <b>${regionName} Region</b><br>
                Approximate boundary<br>
                Uganda has 4 administrative regions[citation:3]
            `).openPopup();
            
            // Zoom to region
            map.fitBounds(currentBoundaryLayer.getBounds());
        }
        
        // Alternative approach for district boundaries
        function showDistrictAlternative(districtName) {
            // Use known district coordinates from OSM data[citation:1]
            const districtCenters = {
                'Kampala': [0.3136, 32.5811],
                'Wakiso': [0.4044, 32.4594],
                'Mbarara': [-0.6072, 30.6585],
                'Gulu': [2.7746, 32.3000],
                'Lira': [2.2480, 32.9000],
                'Mbale': [1.0647, 34.1794],
                'Jinja': [0.4244, 33.2042],
                'Masaka': [-0.3333, 31.7333],
                'Fort Portal': [0.6667, 30.2750],
                'Soroti': [1.7144, 33.6106]
            };
            
            const center = districtCenters[districtName] || [1.3733, 32.2903];
            
            // Create a circle marker as placeholder
            if (currentBoundaryLayer) {
                map.removeLayer(currentBoundaryLayer);
            }
            
            currentBoundaryLayer = L.circle(center, {
                color: '#ffc107',
                weight: 2,
                opacity: 0.8,
                fillOpacity: 0.2,
                fillColor: '#ffc107',
                radius: 15000
            }).addTo(map);
            
            // Add popup
            currentBoundaryLayer.bindPopup(`
                <b>${districtName} District</b><br>
                Approximate location (center point)<br>
                For exact boundaries, use OSM Boundary Tool[citation:2]<br>
                <small>District data from OpenStreetMap Uganda project[citation:1]</small>
            `).openPopup();
            
            // Zoom to district
            map.setView(center, 10);
        }
        
        // Download data functionality
        document.getElementById('download-data-btn').addEventListener('click', function() {
            // Determine what level is selected for download
            let downloadLevel = null;
            let downloadName = null;
            let parentName = null;
            
            if (currentSelection.village && getSelectedText('village-select') !== 'Select a village') {
                downloadLevel = 'Village';
                downloadName = getSelectedText('village-select');
                parentName = getSelectedText('parish-select');
            } else if (currentSelection.parish && getSelectedText('parish-select') !== 'Select a parish') {
                downloadLevel = 'Parish';
                downloadName = getSelectedText('parish-select');
                parentName = getSelectedText('subcounty-select');
            } else if (currentSelection.subcounty && getSelectedText('subcounty-select') !== 'Select a sub-county') {
                downloadLevel = 'Sub-county';
                downloadName = getSelectedText('subcounty-select');
                parentName = getSelectedText('county-select');
            } else if (currentSelection.county && getSelectedText('county-select') !== 'Select a county') {
                downloadLevel = 'County';
                downloadName = getSelectedText('county-select');
                parentName = getSelectedText('district-select');
            } else if (currentSelection.district && getSelectedText('district-select') !== 'Select a district') {
                downloadLevel = 'District';
                downloadName = getSelectedText('district-select');
                parentName = currentSelection.region;
            } else if (currentSelection.region) {
                downloadLevel = 'Region';
                downloadName = currentSelection.region;
                parentName = 'Uganda';
            } else {
                alert('Please select an administrative unit to download data.');
                return;
            }
            
            // Create CSV data
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `HORBTEC_Uganda_${downloadLevel}_${downloadName.replace(/\s+/g, '_')}_${timestamp}`;
            
            let csvContent = "HORBTEC ADMIN UNITS - UGANDA DATA EXPORT\n";
            csvContent += `Generated: ${new Date().toLocaleString()}\n`;
            csvContent += `Administrative Unit: ${downloadName} (${downloadLevel})\n`;
            csvContent += `Parent Unit: ${parentName}\n`;
            csvContent += "Data Sources: OpenStreetMap Uganda Project[citation:1], OpenData Uganda API[citation:5], GeoPostcodes[citation:3]\n\n";
            
            csvContent += "Level,Name,Parent,OSM Admin Level,Data Source\n";
            csvContent += `${downloadLevel},${downloadName},${parentName},${getOSMAdminLevel(downloadLevel)},OpenStreetMap/OpenData Uganda\n`;
            
            // Add hierarchical data if available
            if (downloadLevel === 'District' || downloadLevel === 'Region') {
                csvContent += "\nNOTE: For complete hierarchical data, visit:\n";
                csvContent += "- OpenStreetMap Uganda Boundaries: https://wiki.openstreetmap.org/wiki/WikiProject_Uganda/Uganda_District_Boundaries[citation:1]\n";
                csvContent += "- OpenData Uganda API: https://opendata.ssmusoke.dev/public/locations[citation:5]\n";
                csvContent += "- Overpass Turbo for boundaries: https://overpass-turbo.eu/[citation:4]\n";
            }
            
            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}.csv`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Data for ${downloadName} (${downloadLevel}) downloaded as ${filename}.csv`);
        });
        
        // Get OSM admin level for different unit types
        function getOSMAdminLevel(unitType) {
            switch(unitType) {
                case 'Region': return 'N/A (varies)';
                case 'District': return '4[citation:1]';
                case 'County': return '5-6';
                case 'Sub-county': return '7-8';
                case 'Parish': return '9-10';
                case 'Village': return '10-11';
                default: return 'N/A';
            }
        }
        
        // Reset all selections
        document.getElementById('reset-btn').addEventListener('click', function() {
            // Reset all selects
            document.getElementById('region-select').value = '';
            document.getElementById('district-select').innerHTML = '<option value="">First select a region</option>';
            document.getElementById('district-select').disabled = true;
            document.getElementById('county-select').innerHTML = '<option value="">First select a district</option>';
            document.getElementById('county-select').disabled = true;
            document.getElementById('subcounty-select').innerHTML = '<option value="">First select a county</option>';
            document.getElementById('subcounty-select').disabled = true;
            document.getElementById('parish-select').innerHTML = '<option value="">First select a sub-county</option>';
            document.getElementById('parish-select').disabled = true;
            document.getElementById('village-select').innerHTML = '<option value="">First select a parish</option>';
            document.getElementById('village-select').disabled = true;
            
            // Reset current selection
            currentSelection = {
                region: null,
                district: null,
                county: null,
                subcounty: null,
                parish: null,
                village: null
            };
            
            // Remove boundary layer
            if (currentBoundaryLayer) {
                map.removeLayer(currentBoundaryLayer);
                currentBoundaryLayer = null;
            }
            
            // Reset data table
            updateDataTable();
            
            // Reset map view
            map.setView([1.3733, 32.2903], 7);
            
            alert('All selections have been reset.');
        });
        
        // Initialize data table
        updateDataTable();
        
        // Add some sample data for demonstration
        setTimeout(() => {
            document.getElementById('data-info').innerHTML = 
                '<div class="info-message">üí° <strong>Tip:</strong> Select a region to begin exploring Uganda\'s administrative hierarchy (4 regions, 146 districts[citation:1][citation:3]). Use "Fetch Boundary" to visualize districts on the map.</div>';
        }, 1000);
    </script>
</body>
</html>
