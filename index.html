<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HORBTEC ADMIN UNITS - UGANDA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ug-locations@latest/dist/index.umd.cjs"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #0c4b05 0%, #1a730f 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .logo-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .logo-header i {
            font-size: 2.5rem;
            margin-right: 15px;
            color: #ffdd40;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .description {
            font-size: 1.05rem;
            max-width: 800px;
            margin-top: 10px;
        }
        
        .content-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .controls-panel {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .visualization-panel {
            flex: 2;
            min-width: 500px;
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .panel-title {
            font-size: 1.4rem;
            color: #0c4b05;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeaea;
            display: flex;
            align-items: center;
        }
        
        .panel-title i {
            margin-right: 10px;
            color: #1a730f;
        }
        
        .hierarchy-selectors {
            margin-bottom: 25px;
        }
        
        .selector-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #444;
            font-size: 0.95rem;
        }
        
        select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            background-color: white;
            transition: all 0.3s;
        }
        
        select:focus {
            outline: none;
            border-color: #1a730f;
            box-shadow: 0 0 0 3px rgba(26, 115, 15, 0.1);
        }
        
        .stats-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 4px solid #1a730f;
        }
        
        .stats-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #0c4b05;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 12px;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.03);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a730f;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }
        
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 14px 25px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            min-width: 160px;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-primary {
            background-color: #1a730f;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0c4b05;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(26, 115, 15, 0.2);
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        #visualization {
            width: 100%;
            height: 500px;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .hierarchy-path {
            margin-top: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .path-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #444;
        }
        
        .path-display {
            font-size: 1.1rem;
            color: #0c4b05;
            font-weight: 500;
            padding: 10px;
            background-color: white;
            border-radius: 6px;
            border: 1px dashed #ddd;
            min-height: 60px;
            display: flex;
            align-items: center;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .data-table th {
            background-color: #1a730f;
            color: white;
            text-align: left;
            padding: 15px;
            font-weight: 600;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .data-table tr:hover {
            background-color: #f0f7ee;
        }
        
        footer {
            text-align: center;
            padding: 25px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eaeaea;
            margin-top: 30px;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }
        
        .footer-links a {
            color: #1a730f;
            text-decoration: none;
        }
        
        .footer-links a:hover {
            text-decoration: underline;
        }
        
        .download-options {
            margin-top: 20px;
            display: none;
        }
        
        .download-options.active {
            display: block;
        }
        
        .format-options {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .format-btn {
            padding: 10px 20px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .format-btn:hover {
            background-color: #e0e0e0;
        }
        
        .format-btn.active {
            background-color: #1a730f;
            color: white;
        }
        
        @media (max-width: 1100px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .controls-panel, .visualization-panel {
                min-width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-header">
                <i class="fas fa-map-marked-alt"></i>
                <div>
                    <h1>HORBTEC ADMIN UNITS - UGANDA</h1>
                    <div class="subtitle">Uganda Administrative Hierarchy Visualization & Data Export Module</div>
                </div>
            </div>
            <p class="description">
                This module provides interactive visualization and data export capabilities for Uganda's administrative hierarchy from Region down to Village level. Data is sourced from official Ugandan government publications and open-source databases[citation:7].
            </p>
        </header>
        
        <div class="content-wrapper">
            <div class="controls-panel">
                <h2 class="panel-title"><i class="fas fa-sliders-h"></i> Controls & Filters</h2>
                
                <div class="hierarchy-selectors">
                    <div class="selector-group">
                        <label for="regionSelect"><i class="fas fa-globe-africa"></i> Region / Sub-region</label>
                        <select id="regionSelect">
                            <option value="">All Regions</option>
                            <!-- Regions will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="selector-group">
                        <label for="districtSelect"><i class="fas fa-map"></i> District</label>
                        <select id="districtSelect">
                            <option value="">All Districts</option>
                            <!-- Districts will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="selector-group">
                        <label for="countySelect"><i class="fas fa-map-pin"></i> County</label>
                        <select id="countySelect">
                            <option value="">All Counties</option>
                            <!-- Counties will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="selector-group">
                        <label for="subcountySelect"><i class="fas fa-map-signs"></i> Sub-county</label>
                        <select id="subcountySelect">
                            <option value="">All Sub-counties</option>
                            <!-- Sub-counties will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="selector-group">
                        <label for="parishSelect"><i class="fas fa-dot-circle"></i> Parish</label>
                        <select id="parishSelect">
                            <option value="">All Parishes</option>
                            <!-- Parishes will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="selector-group">
                        <label for="villageSelect"><i class="fas fa-home"></i> Village</label>
                        <select id="villageSelect">
                            <option value="">All Villages</option>
                            <!-- Villages will be populated dynamically -->
                        </select>
                    </div>
                </div>
                
                <div class="stats-box">
                    <div class="stats-title">Administrative Units Statistics</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="districtsCount">0</div>
                            <div class="stat-label">Districts</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="countiesCount">0</div>
                            <div class="stat-label">Counties</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="subcountiesCount">0</div>
                            <div class="stat-label">Sub-counties</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="villagesCount">0</div>
                            <div class="stat-label">Villages</div>
                        </div>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" id="downloadBtn">
                        <i class="fas fa-download"></i> Download Data
                    </button>
                    <button class="btn btn-secondary" id="resetBtn">
                        <i class="fas fa-redo"></i> Reset Filters
                    </button>
                </div>
                
                <div class="download-options" id="downloadOptions">
                    <div class="stats-title">Download Options</div>
                    <p>Select format for downloading the filtered administrative data:</p>
                    <div class="format-options">
                        <button class="format-btn active" data-format="json">JSON Format</button>
                        <button class="format-btn" data-format="csv">CSV Format</button>
                        <button class="format-btn" data-format="geojson">GeoJSON</button>
                    </div>
                    <button class="btn btn-primary" id="confirmDownload" style="margin-top: 20px;">
                        <i class="fas fa-file-download"></i> Download Selected Format
                    </button>
                </div>
            </div>
            
            <div class="visualization-panel">
                <h2 class="panel-title"><i class="fas fa-project-diagram"></i> Hierarchy Visualization</h2>
                <div id="visualization">
                    <!-- D3.js visualization will be rendered here -->
                </div>
                
                <div class="hierarchy-path">
                    <div class="path-title">Selected Administrative Path</div>
                    <div class="path-display" id="pathDisplay">
                        Select an administrative unit to see its full hierarchy path
                    </div>
                </div>
                
                <h2 class="panel-title" style="margin-top: 30px;"><i class="fas fa-table"></i> Data Preview</h2>
                <table class="data-table" id="dataPreview">
                    <thead>
                        <tr>
                            <th>District</th>
                            <th>County</th>
                            <th>Sub-county</th>
                            <th>Parish</th>
                            <th>Village</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <footer>
            <p>© 2026 HORBTEC ADMIN UNITS - UGANDA. Administrative data sourced from Uganda Electoral Commission and open-source databases[citation:7].</p>
            <div class="footer-links">
                <a href="https://data.humdata.org/dataset/d514d1b8-5806-4551-ac05-34fd300f5dbd" target="_blank">HDX Boundary Data[citation:8]</a>
                <a href="https://simplemaps.com/gis/country/ug" target="_blank">Uganda GIS Files[citation:6]</a>
                <a href="https://www.npmjs.com/package/ug-locations" target="_blank">ug-locations NPM[citation:7]</a>
                <a href="https://en.wikipedia.org/wiki/Administrative_divisions_of_Uganda" target="_blank">Uganda Administrative Divisions[citation:1]</a>
            </div>
        </footer>
    </div>

    <script>
        // Initialize the ug-locations package
        const ugLocations = window['ug-locations'];
        
        // Store all administrative data
        let allData = [];
        let filteredData = [];
        let currentHierarchy = {};
        
        // DOM Elements
        const regionSelect = document.getElementById('regionSelect');
        const districtSelect = document.getElementById('districtSelect');
        const countySelect = document.getElementById('countySelect');
        const subcountySelect = document.getElementById('subcountySelect');
        const parishSelect = document.getElementById('parishSelect');
        const villageSelect = document.getElementById('villageSelect');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const downloadOptions = document.getElementById('downloadOptions');
        const formatButtons = document.querySelectorAll('.format-btn');
        const confirmDownloadBtn = document.getElementById('confirmDownload');
        const pathDisplay = document.getElementById('pathDisplay');
        const dataPreview = document.querySelector('#dataPreview tbody');
        
        // Statistics elements
        const districtsCount = document.getElementById('districtsCount');
        const countiesCount = document.getElementById('countiesCount');
        const subcountiesCount = document.getElementById('subcountiesCount');
        const villagesCount = document.getElementById('villagesCount');
        
        // Current download format
        let currentDownloadFormat = 'json';
        
        // Uganda regions/sub-regions from Wikipedia[citation:1]
        const ugandaRegions = [
            "Acholi", "Ankole", "Buganda", "Bugisu", "Bukedi", "Bunyoro", 
            "Busoga", "Elgon", "Karamoja", "Kigezi", "Lango", "Rwenzori", 
            "Sebei", "Teso", "Toro", "West Nile"
        ];
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            setupEventListeners();
            initializeVisualization();
        });
        
        // Initialize with sample data structure
        function initializeData() {
            // Populate regions dropdown
            ugandaRegions.forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionSelect.appendChild(option);
            });
            
            // Try to use ug-locations package if available[citation:7]
            if (ugLocations && ugLocations.getDistricts) {
                try {
                    const districts = ugLocations.getDistricts();
                    populateDistricts(districts);
                    
                    // Get sample data for all districts
                    districts.forEach(district => {
                        const districtData = ugLocations.getDistrict(district);
                        if (districtData) {
                            allData.push(districtData);
                        }
                    });
                    
                    // Update filtered data
                    filteredData = [...allData];
                    updateDataPreview();
                    updateStatistics();
                    
                    console.log('Loaded data from ug-locations package');
                } catch (error) {
                    console.error('Error loading data from ug-locations:', error);
                    loadSampleData();
                }
            } else {
                console.log('ug-locations package not available, loading sample data');
                loadSampleData();
            }
        }
        
        // Load sample data if ug-locations is not available
        function loadSampleData() {
            // Sample data structure based on Uganda's administrative hierarchy[citation:1][citation:3]
            const sampleDistricts = [
                "Kampala", "Wakiso", "Mukono", "Jinja", "Mbale", "Gulu", "Lira", "Mbarara", "Kabale", "Hoima"
            ];
            
            populateDistricts(sampleDistricts);
            
            // Generate sample hierarchical data
            sampleDistricts.forEach(district => {
                const districtCode = district.toUpperCase().substring(0, 3);
                
                // Create 2-3 counties per district
                for (let i = 1; i <= 3; i++) {
                    const countyName = `${district} County ${i}`;
                    
                    // Create 3-5 sub-counties per county
                    for (let j = 1; j <= 4; j++) {
                        const subcountyName = `${countyName} Sub-county ${j}`;
                        
                        // Create 2-4 parishes per sub-county
                        for (let k = 1; k <= 3; k++) {
                            const parishName = `${subcountyName} Parish ${k}`;
                            
                            // Create 3-6 villages per parish
                            for (let l = 1; l <= 5; l++) {
                                const villageName = `${parishName} Village ${l}`;
                                
                                allData.push({
                                    district: district,
                                    county: countyName,
                                    subcounty: subcountyName,
                                    parish: parishName,
                                    village: villageName,
                                    region: ugandaRegions[Math.floor(Math.random() * ugandaRegions.length)]
                                });
                            }
                        }
                    }
                }
            });
            
            filteredData = [...allData];
            updateDataPreview();
            updateStatistics();
        }
        
        // Populate districts dropdown
        function populateDistricts(districts) {
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Region selection change
            regionSelect.addEventListener('change', function() {
                filterByRegion(this.value);
                updateVisualization();
            });
            
            // District selection change
            districtSelect.addEventListener('change', function() {
                filterByDistrict(this.value);
                updateVisualization();
            });
            
            // County selection change
            countySelect.addEventListener('change', function() {
                filterByCounty(this.value);
                updateVisualization();
            });
            
            // Sub-county selection change
            subcountySelect.addEventListener('change', function() {
                filterBySubcounty(this.value);
                updateVisualization();
            });
            
            // Parish selection change
            parishSelect.addEventListener('change', function() {
                filterByParish(this.value);
                updateVisualization();
            });
            
            // Village selection change
            villageSelect.addEventListener('change', function() {
                filterByVillage(this.value);
                updateVisualization();
                
                // Update path display if a village is selected
                if (this.value) {
                    const selectedData = filteredData.find(item => item.village === this.value);
                    if (selectedData) {
                        updatePathDisplay(selectedData);
                    }
                }
            });
            
            // Download button
            downloadBtn.addEventListener('click', function() {
                downloadOptions.classList.add('active');
            });
            
            // Reset button
            resetBtn.addEventListener('click', function() {
                resetFilters();
            });
            
            // Format selection buttons
            formatButtons.forEach(button => {
                button.addEventListener('click', function() {
                    formatButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentDownloadFormat = this.getAttribute('data-format');
                });
            });
            
            // Confirm download button
            confirmDownloadBtn.addEventListener('click', function() {
                downloadData();
            });
        }
        
        // Filter data by region
        function filterByRegion(region) {
            if (!region) {
                filteredData = [...allData];
            } else {
                filteredData = allData.filter(item => item.region === region);
            }
            
            // Update dependent dropdowns
            updateDistrictDropdown();
            updateDataPreview();
            updateStatistics();
            updateVisualization();
        }
        
        // Filter data by district
        function filterByDistrict(district) {
            if (!district) {
                // If no district selected, use region filter if any
                const region = regionSelect.value;
                filterByRegion(region);
                return;
            }
            
            filteredData = allData.filter(item => item.district === district);
            
            // Update dependent dropdowns
            updateCountyDropdown();
            updateDataPreview();
            updateStatistics();
            updateVisualization();
        }
        
        // Filter data by county
        function filterByCounty(county) {
            if (!county) {
                // If no county selected, use district filter if any
                const district = districtSelect.value;
                filterByDistrict(district);
                return;
            }
            
            filteredData = allData.filter(item => item.county === county);
            
            // Update dependent dropdowns
            updateSubcountyDropdown();
            updateDataPreview();
            updateStatistics();
            updateVisualization();
        }
        
        // Filter data by subcounty
        function filterBySubcounty(subcounty) {
            if (!subcounty) {
                // If no subcounty selected, use county filter if any
                const county = countySelect.value;
                filterByCounty(county);
                return;
            }
            
            filteredData = allData.filter(item => item.subcounty === subcounty);
            
            // Update dependent dropdowns
            updateParishDropdown();
            updateDataPreview();
            updateStatistics();
            updateVisualization();
        }
        
        // Filter data by parish
        function filterByParish(parish) {
            if (!parish) {
                // If no parish selected, use subcounty filter if any
                const subcounty = subcountySelect.value;
                filterBySubcounty(subcounty);
                return;
            }
            
            filteredData = allData.filter(item => item.parish === parish);
            
            // Update dependent dropdowns
            updateVillageDropdown();
            updateDataPreview();
            updateStatistics();
            updateVisualization();
        }
        
        // Filter data by village
        function filterByVillage(village) {
            if (!village) {
                // If no village selected, use parish filter if any
                const parish = parishSelect.value;
                filterByParish(parish);
                return;
            }
            
            filteredData = allData.filter(item => item.village === village);
            updateDataPreview();
            updateStatistics();
            updateVisualization();
        }
        
        // Update district dropdown based on filters
        function updateDistrictDropdown() {
            const region = regionSelect.value;
            let districts;
            
            if (region) {
                districts = [...new Set(allData
                    .filter(item => item.region === region)
                    .map(item => item.district))];
            } else {
                districts = [...new Set(allData.map(item => item.district))];
            }
            
            // Update dropdown
            districtSelect.innerHTML = '<option value="">All Districts</option>';
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
            
            // Reset dependent dropdowns
            countySelect.innerHTML = '<option value="">All Counties</option>';
            subcountySelect.innerHTML = '<option value="">All Sub-counties</option>';
            parishSelect.innerHTML = '<option value="">All Parishes</option>';
            villageSelect.innerHTML = '<option value="">All Villages</option>';
        }
        
        // Update county dropdown based on filters
        function updateCountyDropdown() {
            const district = districtSelect.value;
            let counties;
            
            if (district) {
                counties = [...new Set(allData
                    .filter(item => item.district === district)
                    .map(item => item.county))];
            } else {
                counties = [...new Set(filteredData.map(item => item.county))];
            }
            
            // Update dropdown
            countySelect.innerHTML = '<option value="">All Counties</option>';
            counties.forEach(county => {
                const option = document.createElement('option');
                option.value = county;
                option.textContent = county;
                countySelect.appendChild(option);
            });
            
            // Reset dependent dropdowns
            subcountySelect.innerHTML = '<option value="">All Sub-counties</option>';
            parishSelect.innerHTML = '<option value="">All Parishes</option>';
            villageSelect.innerHTML = '<option value="">All Villages</option>';
        }
        
        // Update subcounty dropdown based on filters
        function updateSubcountyDropdown() {
            const county = countySelect.value;
            let subcounties;
            
            if (county) {
                subcounties = [...new Set(allData
                    .filter(item => item.county === county)
                    .map(item => item.subcounty))];
            } else {
                subcounties = [...new Set(filteredData.map(item => item.subcounty))];
            }
            
            // Update dropdown
            subcountySelect.innerHTML = '<option value="">All Sub-counties</option>';
            subcounties.forEach(subcounty => {
                const option = document.createElement('option');
                option.value = subcounty;
                option.textContent = subcounty;
                subcountySelect.appendChild(option);
            });
            
            // Reset dependent dropdowns
            parishSelect.innerHTML = '<option value="">All Parishes</option>';
            villageSelect.innerHTML = '<option value="">All Villages</option>';
        }
        
        // Update parish dropdown based on filters
        function updateParishDropdown() {
            const subcounty = subcountySelect.value;
            let parishes;
            
            if (subcounty) {
                parishes = [...new Set(allData
                    .filter(item => item.subcounty === subcounty)
                    .map(item => item.parish))];
            } else {
                parishes = [...new Set(filteredData.map(item => item.parish))];
            }
            
            // Update dropdown
            parishSelect.innerHTML = '<option value="">All Parishes</option>';
            parishes.forEach(parish => {
                const option = document.createElement('option');
                option.value = parish;
                option.textContent = parish;
                parishSelect.appendChild(option);
            });
            
            // Reset dependent dropdowns
            villageSelect.innerHTML = '<option value="">All Villages</option>';
        }
        
        // Update village dropdown based on filters
        function updateVillageDropdown() {
            const parish = parishSelect.value;
            let villages;
            
            if (parish) {
                villages = [...new Set(allData
                    .filter(item => item.parish === parish)
                    .map(item => item.village))];
            } else {
                villages = [...new Set(filteredData.map(item => item.village))];
            }
            
            // Update dropdown
            villageSelect.innerHTML = '<option value="">All Villages</option>';
            villages.forEach(village => {
                const option = document.createElement('option');
                option.value = village;
                option.textContent = village;
                villageSelect.appendChild(option);
            });
        }
        
        // Update data preview table
        function updateDataPreview() {
            dataPreview.innerHTML = '';
            
            // Show only first 10 rows for performance
            const displayData = filteredData.slice(0, 10);
            
            displayData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.district}</td>
                    <td>${item.county}</td>
                    <td>${item.subcounty}</td>
                    <td>${item.parish}</td>
                    <td>${item.village}</td>
                `;
                
                // Add click event to show hierarchy path
                row.addEventListener('click', function() {
                    updatePathDisplay(item);
                    // Scroll to path display
                    document.querySelector('.hierarchy-path').scrollIntoView({ behavior: 'smooth' });
                });
                
                dataPreview.appendChild(row);
            });
            
            // Show count of displayed rows
            if (filteredData.length > 10) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="5" style="text-align: center; font-style: italic; color: #666;">
                    Showing 10 of ${filteredData.length} records. Use download to get all data.
                </td>`;
                dataPreview.appendChild(row);
            }
        }
        
        // Update statistics display
        function updateStatistics() {
            const uniqueDistricts = new Set(filteredData.map(item => item.district)).size;
            const uniqueCounties = new Set(filteredData.map(item => item.county)).size;
            const uniqueSubcounties = new Set(filteredData.map(item => item.subcounty)).size;
            const uniqueVillages = new Set(filteredData.map(item => item.village)).size;
            
            districtsCount.textContent = uniqueDistricts;
            countiesCount.textContent = uniqueCounties;
            subcountiesCount.textContent = uniqueSubcounties;
            villagesCount.textContent = uniqueVillages;
        }
        
        // Update path display
        function updatePathDisplay(item) {
            const path = `${item.region} → ${item.district} → ${item.county} → ${item.subcounty} → ${item.parish} → ${item.village}`;
            pathDisplay.textContent = path;
        }
        
        // Reset all filters
        function resetFilters() {
            regionSelect.value = '';
            districtSelect.value = '';
            countySelect.value = '';
            subcountySelect.value = '';
            parishSelect.value = '';
            villageSelect.value = '';
            
            filteredData = [...allData];
            updateDistrictDropdown();
            updateDataPreview();
            updateStatistics();
            updateVisualization();
            
            // Hide download options
            downloadOptions.classList.remove('active');
            
            // Reset path display
            pathDisplay.textContent = 'Select an administrative unit to see its full hierarchy path';
        }
        
        // Download data in selected format
        function downloadData() {
            let dataStr, fileName, fileType;
            
            // Prepare data based on selected format
            switch(currentDownloadFormat) {
                case 'json':
                    dataStr = JSON.stringify(filteredData, null, 2);
                    fileName = `uganda_admin_units_${new Date().toISOString().split('T')[0]}.json`;
                    fileType = 'application/json';
                    break;
                    
                case 'csv':
                    // Convert to CSV
                    const headers = ['Region', 'District', 'County', 'Sub-county', 'Parish', 'Village'];
                    const csvRows = [
                        headers.join(','),
                        ...filteredData.map(item => [
                            `"${item.region || ''}"`,
                            `"${item.district}"`,
                            `"${item.county}"`,
                            `"${item.subcounty}"`,
                            `"${item.parish}"`,
                            `"${item.village}"`
                        ].join(','))
                    ];
                    dataStr = csvRows.join('\n');
                    fileName = `uganda_admin_units_${new Date().toISOString().split('T')[0]}.csv`;
                    fileType = 'text/csv';
                    break;
                    
                case 'geojson':
                    // Create simple GeoJSON structure
                    const geoJson = {
                        type: "FeatureCollection",
                        features: filteredData.map((item, index) => ({
                            type: "Feature",
                            properties: {
                                id: index + 1,
                                region: item.region || '',
                                district: item.district,
                                county: item.county,
                                subcounty: item.subcounty,
                                parish: item.parish,
                                village: item.village
                            },
                            geometry: {
                                type: "Point",
                                coordinates: [
                                    32.2903 + (Math.random() - 0.5) * 10, // Approximate Uganda longitude range
                                    1.3733 + (Math.random() - 0.5) * 5   // Approximate Uganda latitude range
                                ]
                            }
                        }))
                    };
                    dataStr = JSON.stringify(geoJson, null, 2);
                    fileName = `uganda_admin_units_${new Date().toISOString().split('T')[0]}.geojson`;
                    fileType = 'application/json';
                    break;
            }
            
            // Create download link
            const blob = new Blob([dataStr], { type: fileType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Hide download options
            downloadOptions.classList.remove('active');
        }
        
        // Initialize D3.js visualization
        function initializeVisualization() {
            const width = document.getElementById('visualization').clientWidth;
            const height = document.getElementById('visualization').clientHeight;
            
            // Create SVG container
            const svg = d3.select('#visualization')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('id', 'd3-visualization');
            
            // Add initial text
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height / 2)
                .attr('text-anchor', 'middle')
                .attr('fill', '#666')
                .text('Hierarchy visualization will appear here when data is loaded');
        }
        
        // Update D3.js visualization based on current data
        function updateVisualization() {
            const width = document.getElementById('visualization').clientWidth;
            const height = document.getElementById('visualization').clientHeight;
            
            // Clear previous visualization
            d3.select('#d3-visualization').remove();
            
            // Create new SVG container
            const svg = d3.select('#visualization')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('id', 'd3-visualization');
            
            // If no data or too much data, show message
            if (filteredData.length === 0) {
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#666')
                    .text('No data available for the selected filters');
                return;
            }
            
            if (filteredData.length > 50) {
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#666')
                    .text(`${filteredData.length} administrative units selected. Visualization available for smaller datasets.`);
                return;
            }
            
            // Create a hierarchical bubble chart for visualization
            const uniqueDistricts = [...new Set(filteredData.map(item => item.district))];
            
            // Calculate counts for each district
            const districtCounts = {};
            uniqueDistricts.forEach(district => {
                districtCounts[district] = filteredData.filter(item => item.district === district).length;
            });
            
            // Create bubble pack layout
            const bubbleData = {
                children: uniqueDistricts.map(district => ({
                    name: district,
                    value: districtCounts[district],
                    children: filteredData
                        .filter(item => item.district === district)
                        .slice(0, 5) // Limit to 5 villages per district for clarity
                        .map(item => ({
                            name: item.village,
                            value: 1,
                            district: item.district,
                            county: item.county,
                            subcounty: item.subcounty
                        }))
                }))
            };
            
            // Create pack layout
            const pack = d3.pack()
                .size([width - 20, height - 20])
                .padding(3);
            
            // Create hierarchy
            const root = d3.hierarchy(bubbleData)
                .sum(d => d.value)
                .sort((a, b) => b.value - a.value);
            
            // Generate pack data
            pack(root);
            
            // Create bubbles
            const node = svg.selectAll('.node')
                .data(root.descendants())
                .enter()
                .append('g')
                .attr('class', d => `node ${d.depth === 0 ? 'root' : d.depth === 1 ? 'district' : 'village'}`)
                .attr('transform', d => `translate(${d.x + 10},${d.y + 10})`);
            
            // Draw circles
            node.append('circle')
                .attr('r', d => d.r)
                .attr('fill', d => {
                    if (d.depth === 0) return '#f0f0f0';
                    if (d.depth === 1) return '#1a730f';
                    return '#4CAF50';
                })
                .attr('opacity', d => d.depth === 0 ? 0 : 0.7)
                .attr('stroke', '#fff')
                .attr('stroke-width', 2);
            
            // Add labels for districts
            node.filter(d => d.depth === 1)
                .append('text')
                .attr('dy', '.3em')
                .attr('text-anchor', 'middle')
                .attr('fill', 'white')
                .attr('font-size', d => Math.max(10, d.r / 5))
                .attr('font-weight', 'bold')
                .text(d => d.data.name.length > 15 ? d.data.name.substring(0, 12) + '...' : d.data.name);
            
            // Add tooltips
            node.append('title')
                .text(d => {
                    if (d.depth === 0) return 'Uganda Administrative Units';
                    if (d.depth === 1) return `${d.data.name} District\n${d.value} administrative units`;
                    return `${d.data.name} Village\nDistrict: ${d.data.district}\nCounty: ${d.data.county}`;
                });
            
            // Add click event to nodes
            node.filter(d => d.depth === 1)
                .style('cursor', 'pointer')
                .on('click', function(event, d) {
                    districtSelect.value = d.data.name;
                    filterByDistrict(d.data.name);
                });
        }
    </script>
</body>
</html>
