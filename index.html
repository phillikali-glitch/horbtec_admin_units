<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HORBTEC ADMIN UNITS - UGANDA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --hor-blue: #0d6efd;
            --hor-light: #e9f2ff;
        }
        .hor-header {
            background: linear-gradient(135deg, var(--hor-blue) 0%, #084298 100%);
            border-bottom: 5px solid #ffc107;
        }
        .card {
            border: none;
            box-shadow: 0 .25rem .75rem rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .form-select:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }
        .hierarchy-path {
            background-color: var(--hor-light);
            border-radius: 0.375rem;
            border-left: 4px solid var(--hor-blue);
        }
        #downloadBtn {
            min-width: 140px;
        }
        .spinner-border {
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="hor-header text-white py-4 mb-4">
        <div class="container">
            <div class="d-flex align-items-center">
                <i class="bi bi-geo-alt-fill display-6 me-3"></i>
                <div>
                    <h1 class="h3 mb-0 fw-bold">HORBTEC ADMIN UNITS - UGANDA</h1>
                    <p class="mb-0 opacity-75">Hierarchical Administrative Data Browser & Export Tool</p>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Control Panel -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-funnel me-2"></i>Select Administrative Unit</h5>
                        <p class="text-muted small mb-3">Selections cascade from region to village. Data updates dynamically.</p>
                        
                        <div class="row g-3">
                            <!-- Dynamically generated selects will appear here -->
                            <div id="selectorsContainer" class="col-12">
                                <div class="alert alert-info">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                        <span>Loading administrative data...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Selected Path Display -->
                        <div id="selectedPath" class="hierarchy-path p-3 mt-3 d-none">
                            <p class="mb-1 text-muted small">Current Selection Path:</p>
                            <p id="pathText" class="mb-0 fw-bold"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Download Panel -->
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title"><i class="bi bi-download me-2"></i>Data Export</h5>
                        <p class="text-muted small flex-grow-1">Download the full dataset or filtered data based on your selection above.</p>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Export Format</label>
                            <select id="formatSelect" class="form-select">
                                <option value="json">JSON (Structured Data)</option>
                                <option value="csv" selected>CSV (Spreadsheet)</option>
                                <option value="txt">Plain Text</option>
                            </select>
                        </div>

                        <div class="mt-auto">
                            <button id="downloadBtn" class="btn btn-success w-100" disabled>
                                <i class="bi bi-download me-1"></i> Download Data
                            </button>
                            <p id="downloadInfo" class="small text-muted mt-2 mb-0 d-none">
                                File will contain: <span id="rowCount">0</span> records
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Preview -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-table me-2"></i>Data Preview</h5>
                <span id="previewCount" class="badge bg-secondary">Loading...</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table id="previewTable" class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Region</th>
                                <th>District</th>
                                <th>County</th>
                                <th>Sub-county</th>
                                <th>Parish</th>
                                <th>Village</th>
                            </tr>
                        </thead>
                        <tbody id="previewBody">
                            <tr><td colspan="6" class="text-center py-5">Loading data preview...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="container mt-5 py-4 border-top text-muted small">
        <div class="row">
            <div class="col-md-6">
                &copy; 2026 HORBTEC Platform. Uganda Administrative Units Module.
            </div>
            <div class="col-md-6 text-md-end">
                Data Source: <a href="https://docs.google.com/spreadsheets/d/1NyCosfvdIjUrsLpymH0lcinP0rcXLUIcaoJMnMJporU/edit?usp=sharing" class="text-decoration-none" target="_blank">Uganda Administrative Database</a>
            </div>
        </div>
    </footer>

    <!-- Core JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 1. CONFIGURATION: REPLACE THIS URL WITH YOUR PUBLISHED SHEET CSV LINK
        // Get this by: File → Share → Publish to web → CSV → Copy link
        const dataUrl = "YOUR_PUBLISHED_GOOGLE_SHEETS_CSV_LINK_HERE"; // <<-- REPLACE THIS

        // 2. Application State
        const appState = {
            allData: [],
            filteredData: [],
            levels: ['Region', 'District', 'County', 'Sub-county', 'Parish', 'Village'],
            currentSelections: {},
            columnMap: {} // Will map level names to column indices
        };

        // 3. DOM Elements
        const dom = {
            container: document.getElementById('selectorsContainer'),
            pathText: document.getElementById('pathText'),
            selectedPath: document.getElementById('selectedPath'),
            previewBody: document.getElementById('previewBody'),
            previewCount: document.getElementById('previewCount'),
            downloadBtn: document.getElementById('downloadBtn'),
            downloadInfo: document.getElementById('downloadInfo'),
            rowCount: document.getElementById('rowCount')
        };

        // 4. Main Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadData();
                initializeColumnMap();
                createSelectorElements();
                updatePreview();
            } catch (error) {
                showError(`Failed to load data: ${error.message}`);
            }
        });

        // 5. Data Loading Function
        async function loadData() {
            if (!dataUrl || dataUrl.includes("YOUR_PUBLISHED_GOOGLE_SHEETS_CSV_LINK_HERE")) {
                throw new Error("Please update the 'dataUrl' variable with your published Google Sheets CSV link.");
            }

            const response = await fetch(dataUrl);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const csvText = await response.text();
            appState.allData = parseCSV(csvText);
            appState.filteredData = [...appState.allData];
            
            if (appState.allData.length === 0) {
                throw new Error("No data found in the spreadsheet.");
            }
        }

        // 6. CSV Parser
        function parseCSV(csv) {
            const rows = csv.split('\n').filter(row => row.trim());
            if (rows.length < 2) return [];
            
            const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
            return rows.slice(1).map(row => {
                const values = row.split(',').map(v => v.trim().replace(/"/g, ''));
                return headers.reduce((obj, header, index) => {
                    obj[header] = values[index] || '';
                    return obj;
                }, {});
            });
        }

        // 7. Initialize Column Mapping
        function initializeColumnMap() {
            if (appState.allData.length === 0) return;
            
            const sample = appState.allData[0];
            const availableColumns = Object.keys(sample);
            
            // Try to auto-map columns based on name similarity
            appState.levels.forEach(level => {
                const match = availableColumns.find(col => 
                    col.toLowerCase().includes(level.toLowerCase()) ||
                    level.toLowerCase().includes(col.toLowerCase())
                );
                appState.columnMap[level] = match || availableColumns[0];
            });
        }

        // 8. Create Selector Elements
        function createSelectorElements() {
            dom.container.innerHTML = '';
            
            appState.levels.forEach((level, index) => {
                const colId = `level-${index}`;
                
                const div = document.createElement('div');
                div.className = 'col-md-4 col-lg-2';
                div.innerHTML = `
                    <label for="${colId}" class="form-label small fw-bold">${level}</label>
                    <select 
                        id="${colId}" 
                        class="form-select level-select" 
                        data-level="${level}"
                        ${index > 0 ? 'disabled' : ''}
                    >
                        <option value="">All ${level}s</option>
                    </select>
                `;
                
                dom.container.appendChild(div);
                
                const select = document.getElementById(colId);
                select.addEventListener('change', (e) => handleSelectionChange(level, e.target.value));
                
                populateSelectOptions(level, select);
            });
        }

        // 9. Populate Select Options
        function populateSelectOptions(level, selectElement) {
            const colName = appState.columnMap[level];
            const levelIndex = appState.levels.indexOf(level);
            const parentLevel = levelIndex > 0 ? appState.levels[levelIndex - 1] : null;
            const parentValue = parentLevel ? appState.currentSelections[parentLevel] : null;
            
            // Filter data based on parent selection
            let filtered = appState.allData;
            if (parentValue) {
                filtered = filtered.filter(row => 
                    row[appState.columnMap[parentLevel]] === parentValue
                );
            }
            
            // Get unique values for this level
            const uniqueValues = [...new Set(filtered
                .map(row => row[colName])
                .filter(value => value && value.trim())
            )].sort();
            
            // Update options
            const currentValue = selectElement.value;
            selectElement.innerHTML = `<option value="">All ${level}s</option>` +
                uniqueValues.map(value => 
                    `<option value="${value}" ${value === currentValue ? 'selected' : ''}>${value}</option>`
                ).join('');
        }

        // 10. Handle Selection Changes
        function handleSelectionChange(level, value) {
            // Update current selection
            if (value) {
                appState.currentSelections[level] = value;
            } else {
                delete appState.currentSelections[level];
            }
            
            // Reset downstream selections
            const levelIndex = appState.levels.indexOf(level);
            for (let i = levelIndex + 1; i < appState.levels.length; i++) {
                const downstreamLevel = appState.levels[i];
                delete appState.currentSelections[downstreamLevel];
                
                const select = document.getElementById(`level-${i}`);
                select.value = '';
                select.disabled = true;
            }
            
            // Enable next level if a value was selected
            if (value && levelIndex < appState.levels.length - 1) {
                const nextSelect = document.getElementById(`level-${levelIndex + 1}`);
                nextSelect.disabled = false;
            }
            
            // Update all selectors
            appState.levels.forEach((lvl, idx) => {
                const select = document.getElementById(`level-${idx}`);
                if (!select.disabled) {
                    populateSelectOptions(lvl, select);
                }
            });
            
            // Filter data and update UI
            filterData();
            updatePathDisplay();
            updatePreview();
            updateDownloadButton();
        }

        // 11. Filter Data Based on Selections
        function filterData() {
            let filtered = [...appState.allData];
            
            Object.entries(appState.currentSelections).forEach(([level, value]) => {
                const colName = appState.columnMap[level];
                filtered = filtered.filter(row => row[colName] === value);
            });
            
            appState.filteredData = filtered;
            dom.rowCount.textContent = filtered.length;
            dom.downloadInfo.classList.toggle('d-none', filtered.length === 0);
        }

        // 12. Update Visual Path Display
        function updatePathDisplay() {
            const pathParts = appState.levels
                .map(level => appState.currentSelections[level])
                .filter(Boolean);
            
            if (pathParts.length > 0) {
                dom.pathText.textContent = pathParts.join(' → ');
                dom.selectedPath.classList.remove('d-none');
            } else {
                dom.selectedPath.classList.add('d-none');
            }
        }

        // 13. Update Data Preview Table
        function updatePreview() {
            const dataToShow = appState.filteredData.slice(0, 25); // First 25 rows
            dom.previewCount.textContent = `${appState.filteredData.length} records`;
            
            if (dataToShow.length === 0) {
                dom.previewBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted">
                            No data to display. Select an administrative unit to filter.
                        </td>
                    </tr>
                `;
                return;
            }
            
            dom.previewBody.innerHTML = dataToShow.map(row => `
                <tr>
                    ${appState.levels.map(level => 
                        `<td>${row[appState.columnMap[level]] || '-'}</td>`
                    ).join('')}
                </tr>
            `).join('');
        }

        // 14. Update Download Button State
        function updateDownloadButton() {
            dom.downloadBtn.disabled = appState.filteredData.length === 0;
        }

        // 15. Download Functionality
        dom.downloadBtn.addEventListener('click', () => {
            if (appState.filteredData.length === 0) return;
            
            const format = document.getElementById('formatSelect').value;
            let content, mimeType, filename;
            
            const selectionPath = Object.values(appState.currentSelections).join('_') || 'all_data';
            const timestamp = new Date().toISOString().slice(0, 10);
            
            switch(format) {
                case 'json':
                    content = JSON.stringify(appState.filteredData, null, 2);
                    mimeType = 'application/json';
                    filename = `horbtec_uganda_${selectionPath}_${timestamp}.json`;
                    break;
                case 'csv':
                    const headers = Object.keys(appState.filteredData[0]);
                    const csvRows = [
                        headers.join(','),
                        ...appState.filteredData.map(row => 
                            headers.map(header => `"${row[header] || ''}"`).join(',')
                        )
                    ];
                    content = csvRows.join('\n');
                    mimeType = 'text/csv';
                    filename = `horbtec_uganda_${selectionPath}_${timestamp}.csv`;
                    break;
                case 'txt':
                    const txtRows = appState.filteredData.map(row => 
                        appState.levels.map(level => 
                            `${level}: ${row[appState.columnMap[level]] || 'N/A'}`
                        ).join(' | ')
                    );
                    content = `HORBTEC Uganda Admin Units - ${timestamp}\nSelection: ${selectionPath}\n\n` +
                             txtRows.join('\n');
                    mimeType = 'text/plain';
                    filename = `horbtec_uganda_${selectionPath}_${timestamp}.txt`;
                    break;
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // 16. Error Display
        function showError(message) {
            dom.container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Data Load Error</strong><br>
                        <small>${message}</small><br>
                        <small class="mt-1">Please ensure you have: 1) Published the Google Sheet as CSV, 2) Updated the dataUrl in the code.</small>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
